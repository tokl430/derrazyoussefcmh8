<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Email Header Cleaner (Final v15)</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 30px;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.15);
      padding: 25px;
    }
    h2 { text-align: center; color: #6f42c1; margin-bottom: 20px; }
    label { font-weight: 600; color: #495057; }
    textarea {
      width: 100%; height: 200px; margin-top: 8px; padding: 12px;
      border: 2px solid #6f42c1; border-radius: 10px;
      font-size: 13px; background: #fdfdfd; resize: vertical;
      white-space: pre-wrap; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      font-family: monospace;
    }
    .buttons { margin-top: 18px; text-align: center; }
    .btn {
      padding: 12px 24px; margin: 8px; border: none; border-radius: 25px;
      font-size: 14px; cursor: pointer; color: #fff;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .import-btn { background: #6f42c1; }
    .clean-btn  { background: #28a745; }
    .export-btn { background: #fd7e14; }
    .clear-btn  { background: #17a2b8; }
    .deselect-btn { background: #dc3545; }
    .apply-btn { background: #007bff; }
    .insert-btn { background: #ff5722; }
    .headers-box {
      margin: 20px 0; padding: 15px; border-radius: 10px;
      background: #f8f9fa; border: 1px solid #dee2e6; max-height: 200px; overflow-y: auto;
    }
    .headers-box label { display: inline-block; margin-right: 15px; margin-bottom: 8px; }
    .options { margin: 20px 0; }
    .options textarea {
      width: 90%; height: 120px; padding: 10px;
      border: 2px solid #6f42c1; border-radius: 10px; resize: vertical;
      font-family: monospace;
    }
    /* style ÿØŸäÿßŸÑ always select */
    .always-box {
      margin: 10px 0;
      padding: 8px;
      background: #f1f3f5;
      border-radius: 8px;
    }
    .always-inner {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 5px;
    }
    #alwaysSelect {
      flex: 1;
      padding: 8px;
      border: 2px solid #6f42c1;
      border-radius: 8px;
    }
    #applySelectBtn, #resetDefaultBtn {
      padding: 8px 12px;
      background: #6c757d;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #applySelectBtn:hover, #resetDefaultBtn:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>

<div class="container">
 <hi class="padding:30px;color:black;font-size:13px;">YOUSSEF DERRAZ CMH8</hi>
  <h2>  NEWSLITTER Cleaner </h2>
 
  <label for="input">Paste NEWSLITTER:</label>
  <textarea id="input" placeholder="Paste header here..."></textarea>

  <input id="fileInput" type="file" accept=".txt,.eml,text/*" style="display:none">

  <div class="buttons">
    <button class="btn import-btn" id="importBtn"> Import</button>
    <button class="btn clean-btn" id="cleanBtn"> Clean</button>
    <button class="btn export-btn" id="exportBtn"> Export</button>
    <button class="btn clear-btn" id="clearBtn"> Clear</button>
    <button class="btn deselect-btn" id="deselectBtn"> Deselect All</button>
  </div>

  <h3>Choose PARAMS to remove:</h3>

 
  <div class="always-box">
    <label><b>ÿØŸäŸÖÿß ÿÆŸÑŸä ŸáÿßÿØ ÿßŸÑÿ®ÿßÿ±ÿßŸÖŸäÿ™ÿ±ÿßÿ™ (separated b virgule):</b></label><br>
    <div class="always-inner">
      <input type="text" id="alwaysSelect">
      <button type="button" id="applySelectBtn">‚úîÔ∏è Select</button>
      <button type="button" id="resetDefaultBtn">‚ôªÔ∏è Reset Default</button>
    </div>
  </div>

  <div id="headersBox" class="headers-box">
    <p style='color:#666'>üëâ Paste or Import a header to see available fields...</p>
  </div>

  <div class="options">
    <label>Custom From Name:</label>
    <input type="text" id="customName" placeholder="FROM NAME">

    <div>
      <label><input type="checkbox" id="toggleRdns"> Replace domain with [RDNS]</label><br>
      <label><input type="checkbox" id="toggleRpath"> Replace domain with [P_RPATH]</label><br>
      <label><input type="checkbox" id="toggleEid"> Add [eid] in Message-ID</label><br>
      <label><input type="checkbox" id="toggleIp">  [ip]</label><br>
      <label><input type="checkbox" id="toggleHead"> HIDE NEWSLITTER</label>
    </div>
    <button class="btn apply-btn" id="applyBtn"> Apply</button>
  </div>

  <div class="options">
    <label> Insert HTML:</label><br>
    <textarea id="insertText" placeholder="Enter text to insert above &lt;head&gt;"></textarea><br>
    <button class="btn insert-btn" id="insertBtn"> Insert HTML</button>
  </div>

  <h3>Cleaned STR:</h3>
  <textarea id="output" placeholder="Result will appear here..."></textarea>
</div>

<script>
const fileInput  = document.getElementById('fileInput');
const importBtn  = document.getElementById('importBtn');
const cleanBtn   = document.getElementById('cleanBtn');
const exportBtn  = document.getElementById('exportBtn');
const clearBtn   = document.getElementById('clearBtn');
const deselectBtn= document.getElementById('deselectBtn');
const applyBtn   = document.getElementById('applyBtn');
const insertBtn  = document.getElementById('insertBtn');
const inputArea  = document.getElementById('input');
const outputArea = document.getElementById('output');
const headersBox = document.getElementById('headersBox');
const customNameInput = document.getElementById('customName');
const insertTextInput = document.getElementById('insertText');

// always select elements
const alwaysSelectInput = document.getElementById("alwaysSelect");
const applySelectBtn = document.getElementById("applySelectBtn");
const resetDefaultBtn = document.getElementById("resetDefaultBtn");
const defaultHeaders = "ARC-Authentication-Results, ARC-Message-Signature, ARC-Seal, Authentication-Results, DKIM-Signature, Received-SPF, Return-Path, X-Google-Smtp-Source, sender, Delivered-To";

importBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', async (evt) => {
  const file = evt.target.files[0];
  if (!file) return;
  inputArea.value = await file.text();
  fileInput.value = '';
  buildHeaderCheckboxes();
});
inputArea.addEventListener('input', buildHeaderCheckboxes);

function buildHeaderCheckboxes() {
  const text = inputArea.value;
  if (!text.trim()) {
    headersBox.innerHTML = "<p style='color:#666'>üëâ Paste or Import a header to see available fields...</p>";
    return;
  }
  const matches = [...text.matchAll(/^([\w\-]+):/gmi)].map(m => m[1]);
  const unique = [...new Set(matches)].sort();
  if (!unique.length) {
    headersBox.innerHTML = "<p style='color:#666'>No headers found.</p>";
    return;
  }

  headersBox.innerHTML = "";
  unique.forEach(h => {
    const id = "chk_" + h.replace(/[^a-z0-9]/gi, "_");
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" id="${id}" data-header="${h}" checked> ${h}`;
    headersBox.appendChild(label);
  });

  applyAlwaysSelect();
}

function removeHeaderBlock(text, header) {
  const re = new RegExp("(^" + header + ".*(?:\\r?\\n[ \\t].*)*)", "gmi");
  return text.replace(re, "");
}

function cleanHeader() {
  let text = inputArea.value;
  if (!text.trim()) { alert("Paste or import a header first."); return; }
  const checks = headersBox.querySelectorAll("input[type=checkbox]:checked");
  checks.forEach(chk => { const h = chk.dataset.header; text = removeHeaderBlock(text,h); });
  text = text.replace(/^Received: by[^\n]*(?:\r?\n.*)?/gmi, "");
  text = text.replace(/^X-Received: by[^\n]*(?:\r?\n.*)?/gmi, "");
  text = text.replace(/^\s*[\r\n]/gm, "");
  outputArea.value = text.trim();
}
cleanBtn.addEventListener('click', cleanHeader);

exportBtn.addEventListener('click', () => {
  const text = outputArea.value;
  if (!text.trim()) { alert("Nothing to export."); return; }
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "cleaned_header.txt";
  link.click();
});

clearBtn.addEventListener('click', () => {
  inputArea.value = "";
  outputArea.value = "";
  headersBox.innerHTML = "<p style='color:#666'>üëâ Paste or Import a header to see available fields...</p>";
});

deselectBtn.addEventListener('click', () => {
  const checks = headersBox.querySelectorAll("input[type=checkbox]");
  checks.forEach(chk => chk.checked = false);
});

// Apply transformations
function applyTransformations() {
  let text = outputArea.value || inputArea.value;
  if (!text.trim()) { alert("Paste, import, or clean a header first."); return; }

  const custom = customNameInput.value.trim();

  // RDNS
  if (document.getElementById("toggleRdns").checked) {
    text = text.replace(/^From:\s*(?:(.*?)\s*)?<([^@<\s]+)@([^\s>]+)>/gmi, (m, disp, user, domain) => {
      const newDisp = custom || disp || "";
      return `From: ${newDisp ? newDisp + " " : ""}<${user}@[RDNS]>`;
    });
  }

  // RPATH
  if (document.getElementById("toggleRpath").checked) {
    text = text.replace(/^From:\s*(?:(.*?)\s*)?<([^@<\s]+)@([^\s>]+)>/gmi, (m, disp, user, domain) => {
      const newDisp = custom || disp || "";
      return `From: ${newDisp ? newDisp + " " : ""}<${user}@[P_RPATH]>`;
    });
  }

  // Message-ID eid
  if (document.getElementById("toggleEid").checked) {
    text = text.replace(/^Message-ID:\s*<([^@>]+)@([^>]+)>/gmi, "Message-ID: <$1[eid]@$2>");
  }

  // Toggle [ip] -> always in new line
  if (document.getElementById("toggleIp").checked) {
    if (!text.includes("[ip]")) {
      text = text.replace(/(<!DOCTYPE|<html|<img)/i, "\n[ip]\n$1");
    }
  } else {
    text = text.replace(/\s*\[ip\]\s*/gi, "");
  }

  // Add <head><select> -> always in new line
  if (document.getElementById("toggleHead").checked) {
    if (!text.includes("<head><select>")) {
      text = text.replace(/(<!DOCTYPE[^>]*>)/i, "$1\n<head><select>");
    }
  } else {
    text = text.replace(/<head><select>/gi, "");
  }

  outputArea.value = text.trim();
}
applyBtn.addEventListener('click', applyTransformations);

// Insert custom text above <head><select>
insertBtn.addEventListener('click', () => {
  let text = outputArea.value || inputArea.value;
  if (!text.trim()) { alert("Paste, import, or clean a header first."); return; }
  const customText = insertTextInput.value;
  if (!customText.trim()) { alert("Write something first."); return; }

  text = text.replace(/(<head><select>)/i, "\n" + customText + "\n$1");
  outputArea.value = text;
});

// Always select functions
function applyAlwaysSelect() {
  const input = alwaysSelectInput.value;
  if (!input.trim()) return;
  const mustSelect = input.split(",").map(s => s.trim().toLowerCase()).filter(Boolean);
  const checks = document.querySelectorAll("#headersBox input[type=checkbox]");
  checks.forEach(chk => {
    if (mustSelect.includes(chk.dataset.header.toLowerCase())) {
      chk.checked = true;
    }
  });
}

alwaysSelectInput.addEventListener("input", () => {
  localStorage.setItem("alwaysSelectParams", alwaysSelectInput.value);
});

window.addEventListener("load", () => {
  const saved = localStorage.getItem("alwaysSelectParams");
  alwaysSelectInput.value = saved || defaultHeaders;
});

applySelectBtn.addEventListener("click", () => {
  applyAlwaysSelect();
});

resetDefaultBtn.addEventListener("click", () => {
  alwaysSelectInput.value = defaultHeaders;
  applyAlwaysSelect();
  localStorage.setItem("alwaysSelectParams", defaultHeaders);
});

</script>

</body>
</html>
